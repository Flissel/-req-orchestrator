# C4 Architektur-Übersicht Zielzustand

Hinweis: Quelle in docs/architecture/C4.puml. Diese Datei enthält eine Mermaid-Preview je Level.

## Level 1 System Context

```mermaid
flowchart LR
  user[Primärer Nutzer]
  browser[Browser Frontend statisches HTML CSS JS]
  backend[Backend Flask API]
  db[SQLite Datenbank]
  openai[OpenAI API externes LLM]

  user -->|Bedient UI| browser
  nginx[NGINX Static Serving]
  nginx -->|Liefert Assets| browser
  browser -->|HTTPS GET health und /api/*| backend
  backend -->|SQL Lese Schreibzugriffe| db
  backend -->|Prompts Completions| openai
```

## Level 2 Container

```mermaid
flowchart LR
  subgraph Docker Compose Umgebung
    nginx[NGINX Container Static Assets]
    flask[Gunicorn Flask API Container]
    sqlite[SQLite Datei app.db oder data app.db]
  end
  user[Primärer Nutzer]
  browser[Browser]
  openai[OpenAI API Extern]

  user -->|Bedient| browser
  nginx -->|Static Files| browser
  browser -->|HTTPS JSON| flask
  flask -->|Dateizugriff| sqlite
  flask -->|HTTPS| openai
```

## Dev System Setup (v2 LangExtract)

- Dienste/Ports (lokal):

  - Frontend Dev: `http://localhost:5173` (alternativ statisch: `frontend/mining_demo.html`)
  - Nginx Proxy: `http://localhost:8080` (optional)
  - v2 FastAPI Wrapper (Flask eingebettet): `http://localhost:8082`
  - SQLite: `./data/app.db`
  - Qdrant (optional): `6333/6335`
  - OpenAI API: extern
- Start (lokal):

  - Backend v2: `python -m uvicorn backend_app_v2.main:fastapi_app --host 0.0.0.0 --port 8082 --reload`
  - Frontend: beliebiger Static-Server für `frontend/` oder direkt im Browser öffnen
- Hauptendpunkte (v2):

  - `POST /api/v1/lx/extract` – Mining (Datei-Upload, Chunking, Fast-Mode, Few-shot via Gold)
  - `GET/POST /api/v1/lx/config/*` – Konfigurationsverwaltung (Prompts/Beispiele)
  - `GET/POST /api/v1/lx/gold/*` – Gold-Sets verwalten/auto-generieren
  - `POST /api/v1/lx/evaluate` – Evaluation P/R/F1 gegen Gold
  - `POST /api/v1/lx/evaluate/auto` – One‑Click: Extract → Auto‑Gold → Evaluate

- Speicherpfade (v2):
  - Ergebnisse (LX): `./data/lx_results/*.json`
  - Gold‑Sets: `./data/lx_gold/{goldId}.json`

```mermaid
flowchart LR
  FE["Frontend Mining Demo"] -->|multipart/form-data| EXTRACT["POST /api/v1/lx/extract"]
  EXTRACT --> LLM["OpenAI (optional, je nach Mode)"]
  EXTRACT --> RES["./data/lx_results/*.json"]
  FE --> GOLD["GET/POST /api/v1/lx/gold/*"]
  FE --> EVAL["POST /api/v1/lx/evaluate(/auto)"]
  EVAL --> RES
```

## Level 3 Komponenten Backend

```mermaid
flowchart LR
  subgraph Flask API Container
    api_layer[Blueprint Konsolidierter API Layer]
    llm_service[LLM Service Wrapper OpenAI]
    db_access[DB Access SQLite]
    settings[Settings Config]
    utils[Utils Helper]
    wsgi[WSGI App und App Fabrik]
  end

  browser[Browser]
  browser -->|HTTP JSON| api_layer
  wsgi -->|initialisiert| api_layer
  wsgi -->|lädt| settings
  api_layer -->|ruft| llm_service
  api_layer -->|persistiert liest| db_access
  api_layer -->|nutzt| utils

  endpoints[Endpoints<br/>GET /health<br/>GET /api/demo/requirements<br/>POST /api/validate<br/>POST /api/validate/parallel<br/>POST /api/validate/batch<br/>GET POST /api/validate/config<br/>POST /api/v1/corrections/text und decisions]
  endpoints -. dokumentiert .- api_layer
```

### Komponenten-Ergänzung v2 (LangExtract)

```mermaid
flowchart LR
  subgraph "FastAPI Wrapper (Port 8082)"
    flask_mount["Flask App Mount /"]
    lx_api["Blueprint lx/*"]
    config_api["Blueprint lx/config/*"]
    gold_api["Blueprint lx/gold/*"]
    eval_api["Blueprint lx/evaluate/*"]
  end

  lx_api -->|ruft| llm_service["LLM Service"]
  lx_api -->|schreibt| res_dir["./data/lx_results"]
  gold_api -->|liest/schreibt| gold_dir["./data/lx_gold"]
  eval_api -->|liest| res_dir
```

Abweichungen zum aktuellen Stand werden in docs/architecture/README.md genannt.

<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Requirements Mining Demo</title>
  <link rel="stylesheet" href="./styles.css"/>
  <style>
    :root {
      --bg:#0b0e14; --fg:#e6e6e6; --muted:#9aa5b1; --accent:#4cc9f0; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --card:#11151c; --card2:#0f1320; --chip:#2a3242;
    }
    body { background:var(--bg); color:var(--fg); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif; height:100%; margin:0; }
    .container { width: 100vw; max-width: 100vw; height: 100vh; margin: 0; padding: 12px; box-sizing: border-box; }
    h1 { font-size: 22px; margin: 8px 0 16px; color: var(--fg); }
    .panel { background: var(--card); border: 1px solid #1f2937; border-radius: 12px; padding: 16px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin: 8px 0; }
    .row label { color: var(--muted); font-size: 14px; }
    input[type="text"] { background: var(--card2); border:1px solid #1f2937; color:var(--fg); padding:10px 12px; border-radius:10px; outline:none; min-width: 240px; }
    input[type="file"] { color: var(--muted); }
    .btn { background: var(--accent); color:#061018; border:0; padding:10px 16px; border-radius:10px; font-weight:600; cursor:pointer; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .hint { color: var(--muted); font-size: 13px; }
    .result { margin-top: 16px; }
    .card { background: var(--card2); border: 1px solid #1f2937; border-radius: 12px; padding: 14px; margin: 10px 0; }
    .card h3 { margin: 0 0 6px; font-size: 16px; }
    .chips { display:flex; gap:8px; flex-wrap:wrap; margin-top: 8px; }
    .chip { background: var(--chip); color: #d1e4ff; border-radius:999px; padding:4px 10px; font-size:12px; border:1px solid #22304a; }
    .meta { color: var(--muted); font-size: 12px; margin-top: 6px; }
    .status { margin-top: 10px; font-size: 13px; }
    .status.ok { color: var(--ok); }
    .status.err { color: var(--err); }
    .status.warn { color: var(--warn); }
    .divider { height:1px; background:#1f2937; margin:12px 0; }

    /* Drei-Spalten-Layout für Demo (Requirements | Graph | Preview) */
    .split { display:grid; grid-template-columns: 1.2fr 0fr 1fr; gap:16px; align-items:stretch; height: calc(100vh - 64px); }
    @media (max-width: 1200px) { .split { grid-template-columns: 1fr; height: auto; } }
    .left { min-width:0; }
    .center { display:none; }
    .right { min-width:0; }

    /* Graph in der Mitte */
    .graph-box { border:1px solid #1f2937; border-radius:12px; background: var(--card2); height: 100%; overflow:hidden; }

    /* Panel/Preview full-height */
    .left .panel { height: 100%; display: flex; flex-direction: column; min-height: 0; }
    #results { flex: 1 1 auto; overflow: auto; min-height: 0; }
    .right { display: flex; flex-direction: column; min-height: 0; }

    /* Preview rechts */
    .preview-meta { color: var(--muted); font-size:12px; margin: 6px 0 8px; }
    .preview-box { border:1px solid #1f2937; border-radius:12px; background: var(--card2); overflow:auto; height: 60vh; flex: 1 1 auto; }
    .preview-text { margin:0; padding:12px; color: var(--fg); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; white-space: pre-wrap; word-wrap: break-word; }

    /* aktive Karte markieren */
    .card.active { outline: 2px solid var(--accent); }
    /* Vollbild-Modal für Knowledge Graph */
    .kg-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; z-index: 9999; }
    .kg-modal.show { display: flex; flex-direction: column; }
    .kg-modal-header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; background: var(--card); border-bottom:1px solid #1f2937; }
    .kg-modal-title { font-weight:700; }
    .kg-modal-actions .btn { margin-left:8px; }
    .kg-modal-body { flex:1 1 auto; min-height:0; padding:12px; background: var(--card2); }
    #cyModal { width: 100%; height: 100%; border:1px solid #1f2937; border-radius:12px; background:#0d1220; }

  </style>
  <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
  <script src="https://unpkg.com/layout-base/layout-base.js"></script>
  <script src="https://unpkg.com/cose-base/cose-base.js"></script>
  <script src="https://unpkg.com/cytoscape-fcose@2.2.0/cytoscape-fcose.js"></script>
  <script>window.API_BASE = window.API_BASE || 'http://localhost:8082';</script>
  <!-- Cache-Busting, damit die aktualisierte JS-Version sicher geladen wird -->
  <script defer src="./mining_demo.js?v=6"></script>
</head>
<body>
  <div class="container">
    <h1>Requirements Mining Demo</h1>

    <div class="split">
      <div class="left">
        <div class="panel">
          <div class="row">
            <label for="files"><strong>Datei(en):</strong></label>
            <input id="files" type="file" accept=".md,.markdown,.txt,.pdf,.docx,.json" multiple />
          </div>

          <div class="row">
            <button id="btnMine" class="btn">Mine Requirements</button>
            <button id="btnSample" class="btn" style="background:#22c55e">Beispiel laden</button>
            <button id="btnReports" class="btn" style="background:#64748b" onclick="location.href='./reports.html'">Reports & Configs</button>
          </div>
          <div class="row">
            <label style="display:flex;align-items:center;gap:6px;"><input id="neighbors" type="checkbox"/> Nachbarschafts-Evidenz (±1)</label>
            <label style="display:flex;align-items:center;gap:6px;"><input id="passParagraph" type="checkbox"/> Paragraph-Pass</label>
            <label style="display:flex;align-items:center;gap:6px;"><input id="fastMode" type="checkbox" checked/> Fast Mode</label>
            <label>Temp
              <input id="temperature" type="number" step="0.1" min="0.0" max="1.0" value="0.2" style="width:100px"/>
            </label>
          </div>
          <div class="row">
            <label>Chunk-Größe
              <input id="chunkSize" type="number" value="4000" style="width:120px"/>
            </label>
            <label>Overlap
              <input id="chunkOverlap" type="number" value="300" style="width:120px"/>
            </label>
            <label style="display:flex;align-items:center;gap:6px;"><input id="useCustomChunks" type="checkbox"/> Custom Chunking verwenden</label>
          </div>
          <div class="row">
            <label for="cfgSelect"><strong>Config:</strong></label>
            <select id="cfgSelect" style="min-width:200px"></select>
            <button id="btnLoadCfg" class="btn">Config laden</button>
            <button id="btnPreviewCfg" class="btn" style="background:#38bdf8">Config Preview</button>
          </div>

          <div class="row">
            <label style="display:flex;align-items:center;gap:6px;"><input id="useGoldFewshot" type="checkbox"/> Gold als Few‑Shot</label>
            <label style="display:flex;align-items:center;gap:6px;"><input id="autoGold" type="checkbox"/> Auto‑Gold wenn fehlend</label>
            <label for="goldSelect"><strong>Gold‑Set:</strong></label>
            <select id="goldSelect" style="min-width:200px"><option value="">(kein)</option></select>
            <button id="btnReloadGold" class="btn" style="background:#64748b">Gold aktualisieren</button>
          </div>

          <!-- Zusätzliche Konfiguration/Reports wurden in eine eigene Seite ausgelagert -->

          <div class="hint">
            Lade ein Markdown/Text/PDF hoch. Jeder Chunk wird vom Agent extrahiert, gemined und als Requirements-DTO zurückgegeben.
            Optional: „LLM-Expand“ erzeugt zusätzliche Knoten/Kanten per LLM (mehr Kosten/Latenz), Standard ist heuristisch ohne LLM.
          </div>

          <div id="status" class="status"></div>

          <div class="divider"></div>

          <div id="results" class="result"></div>
        </div>
      </div>

      <div class="center">
        <h3>Knowledge Graph</h3>
        <div id="graphBox" class="graph-box">
          <div id="cy" style="width:100%; height:100%;"></div>
        </div>
      </div>

      <div class="right">
        <h3>Dokument-Vorschau</h3>
        <div id="previewMeta" class="preview-meta">Keine Datei geladen.</div>
        <div id="previewBox" class="preview-box">
          <pre id="previewText" class="preview-text"></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- Vollbild-Graph Modal -->
  <div id="kgModal" class="kg-modal" aria-hidden="true">
    <div class="kg-modal-header">
      <div class="kg-modal-title">Knowledge Graph – Vollbild</div>
      <div class="kg-modal-actions">
        <button id="btnKgRelayout" class="btn">Neu layouten</button>
        <button id="btnKgFit" class="btn" style="background:#22c55e">Fit</button>
        <button id="btnKgExportPng" class="btn" style="background:#38bdf8">PNG speichern</button>
        <button id="btnKgExportJson" class="btn" style="background:#a78bfa">JSON speichern</button>
        <button id="btnKgClose" class="btn" style="background:#ef4444">Schließen</button>
      </div>
    </div>
    <div class="kg-modal-body">
      <div id="cyModal"></div>
    </div>
  </div>
</body>
</html>
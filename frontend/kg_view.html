<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Knowledge Graph – Requirements</title>
  <link rel="stylesheet" href="./styles.css"/>
  <style>
    :root { --bg:#0b0e14; --fg:#e6e6e6; --muted:#9aa5b1; --accent:#4cc9f0; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --card:#11151c; --card2:#0f1320; --chip:#2a3242; }
    body { background:var(--bg); color:var(--fg); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; height:100%; margin:0; }
    .container { width: 100vw; max-width: 100vw; height: 100vh; margin: 0; padding: 12px; box-sizing: border-box; }
    h1 { font-size: 22px; margin: 8px 0 16px; color: var(--fg); }
    .panel { background: var(--card); border: 1px solid #1f2937; border-radius: 12px; padding: 16px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin: 8px 0; }
    label { color: var(--muted); font-size: 14px; }
    input[type="text"], input[type="number"], select { background: var(--card2); border:1px solid #1f2937; color:var(--fg); padding:10px 12px; border-radius:10px; outline:none; }
    .btn { background: var(--accent); color:#061018; border:0; padding:10px 16px; border-radius:10px; font-weight:600; cursor:pointer; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .status { margin-top: 6px; font-size: 13px; }
    .status.ok { color: var(--ok); }
    .status.err { color: var(--err); }
    .grid { display:grid; grid-template-columns: 320px 1fr; gap:16px; align-items:stretch; height: calc(100vh - 64px); }
    @media (max-width: 1000px) { .grid { grid-template-columns: 1fr; height: auto; } }
    #cy { width: 100%; height: 100%; background: #0d1220; border:1px solid #1f2937; border-radius: 12px; }
    .list { height: 100%; overflow:auto; border:1px solid #1f2937; border-radius:12px; background: var(--card2); }
    .item { padding:10px 12px; border-bottom: 1px solid #1f2937; cursor:pointer; }
    .item:hover { background:#162032; }

    /* Full-height columns */
    .left .panel { height: 100%; display: flex; flex-direction: column; min-height: 0; }
    #kgList { flex: 1 1 auto; min-height: 0; }
  </style>
  <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
  <script src="https://unpkg.com/layout-base/layout-base.js"></script>
  <script src="https://unpkg.com/cose-base/cose-base.js"></script>
  <script src="https://unpkg.com/cytoscape-fcose@2.2.0/cytoscape-fcose.js"></script>
  <script>window.API_BASE = window.API_BASE || 'http://localhost:8000';</script>
</head>
<body>
  <div class="container">
    <h1>Knowledge Graph – Requirements</h1>
    <div class="grid">
      <div class="left">
        <div class="panel">
          <div class="row">
            <label for="kgQuery"><strong>Suche:</strong></label>
            <input id="kgQuery" type="text" placeholder="z. B. Benutzer, Profil, Passwort, Action …" style="min-width:260px"/>
            <label for="kgTopK">Top K:</label>
            <input id="kgTopK" type="number" min="1" max="1000" value="25" style="width:90px"/>
            <button id="btnKgSearch" class="btn">Knoten suchen</button>
            <button id="btnKgReset" class="btn" style="background:#eab308">Reset</button>
          </div>
          <div class="row">
            <label for="kgNodeId"><strong>Node-ID:</strong></label>
            <input id="kgNodeId" type="text" placeholder="z. B. REQ-..., Actor:benutzer, Entity:Profil" style="min-width:260px"/>
            <label for="kgDir">Richtung:</label>
            <select id="kgDir">
              <option value="both" selected>both</option>
              <option value="out">out</option>
              <option value="in">in</option>
            </select>
            <label for="kgRel">Rel(s):</label>
            <input id="kgRel" type="text" placeholder="z. B. HAS_ACTION,ON_ENTITY" style="min-width:200px"/>
            <label for="kgLimit">Limit:</label>
            <input id="kgLimit" type="number" min="1" max="2000" value="200" style="width:90px"/>
            <button id="btnKgExpand" class="btn" style="background:#22c55e">Nachbarn laden</button>
          </div>
          <div id="kgStatus" class="status"></div>
          <div id="kgList" class="list"></div>
          <div class="row">
            <button id="btnExportPng" class="btn" style="background:#38bdf8">PNG speichern</button>
            <button id="btnExportJson" class="btn" style="background:#a78bfa">JSON speichern</button>
            <a class="btn" href="./mining_demo.html" style="text-decoration:none;display:inline-block;">Zur Mining-Demo</a>
          </div>
        </div>
      </div>
      <div class="right">
        <div id="cy"></div>
      </div>
    </div>
  </div>
  <script>
  (() => {
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const statusEl = $("#kgStatus");
    const listEl = $("#kgList");
    const queryEl = $("#kgQuery");
    const topKEl = $("#kgTopK");
    const nodeIdEl = $("#kgNodeId");
    const dirEl = $("#kgDir");
    const relEl = $("#kgRel");
    const limitEl = $("#kgLimit");

    function setStatus(text, cls="") {
      statusEl.className = "status " + (cls||"");
      statusEl.textContent = text || "";
    }

    async function getJSON(url) {
      const resp = await fetch(url);
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok || data.success === false) {
        const msg = (data && data.message) ? data.message : ("HTTP " + resp.status);
        throw new Error(msg);
      }
      return data;
    }

    function cyStyles() {
      return [
        // Basistexte mit dunklem Text-Hintergrund statt weißem Highlight
        { selector: 'node', style: {
          'label':'data(name)',
          'color':'#e6e6e6',
          'background-color':'#4cc9f0',
          'font-size':'10px',
          'min-zoomed-font-size':6,
          'text-wrap':'wrap',
          'text-max-width':'180px',
          'text-background-color':'transparent',
          'text-background-opacity':0,
          'text-background-padding':'3px',
          'text-background-shape':'roundrectangle',
          'text-outline-width':0,
          'text-outline-color':'transparent'
        }},
        { selector: 'node[type = "Requirement"]', style: { 'shape':'round-rectangle', 'background-color':'#38bdf8' } },
        { selector: 'node[type = "Actor"]', style: { 'shape':'ellipse', 'background-color':'#a78bfa' } },
        { selector: 'node[type = "Action"]', style: { 'shape':'diamond', 'background-color':'#22c55e' } },
        { selector: 'node[type = "Entity"]', style: { 'shape':'rectangle', 'background-color':'#f97316' } },
        // Tag-Knoten: heller Hintergrund, dunkle Schrift, KEIN dunkler Text-Hintergrund
        { selector: 'node[type = "Tag"]', style: { 'shape':'hexagon', 'background-color':'#60a5fa', 'color':'#061018', 'border-width':2, 'border-color':'#93c5fd', 'text-background-opacity':0 } },
        { selector: 'edge', style: { 'width':1.5, 'line-color':'#94a3b8', 'opacity':0.7, 'target-arrow-color':'#94a3b8', 'target-arrow-shape':'triangle', 'curve-style':'bezier', 'label':'data(rel)', 'font-size':'9px', 'min-zoomed-font-size':10, 'text-rotation':'autorotate', 'text-background-color':'transparent', 'text-background-opacity':0, 'text-background-padding':'2px', 'text-outline-width':0, 'text-outline-color':'transparent' } },
        // Auswahl-Overlay deaktivieren
        { selector: 'node:selected', style: { 'overlay-opacity': 0 } },
        { selector: 'edge:selected', style: { 'overlay-opacity': 0 } }
      ];
    }

    const cy = cytoscape({
      container: document.getElementById('cy'),
      elements: [],
      style: cyStyles(),
      layout: { name: (typeof window !== 'undefined' && window.fcose) ? 'fcose' : 'cose',
        quality:'proof', randomize:true, animate:false, fit:true,
        idealEdgeLength:300, nodeSeparation:360, componentSpacing:480, gravity:0.12,
        nodeRepulsion:900000, nestingFactor:0.8, packComponents:true, padding:120,
        nodeDimensionsIncludeLabels:true, tile:true
      }
    });

    cy.on('tap', 'node', (evt) => {
      const n = evt.target;
      nodeIdEl.value = n.id();
    });

    function upsertNode(payload, score) {
      const id = payload.node_id || payload.id;
      if (!id) return;
      if (cy.getElementById(id).length) return;
      const name = payload.name || id;
      const type = payload.type || 'Unknown';
      cy.add({ group: 'nodes', data: { id, name, type, score: score || 0 } });
    }

    function upsertEdge(payload) {
      const id = payload.edge_id || (payload.from_node_id + '#' + payload.rel + '#' + payload.to_node_id);
      const from = payload.from_node_id, to = payload.to_node_id, rel = payload.rel || 'RELATES_TO';
      if (!id || !from || !to) return;
      if (cy.getElementById(id).length) return;
      // Ensure nodes exist
      if (!cy.getElementById(from).length) {
        cy.add({ group:'nodes', data:{ id: from, name: from, type: 'Unknown' } });
      }
      if (!cy.getElementById(to).length) {
        cy.add({ group:'nodes', data:{ id: to, name: to, type: 'Unknown' } });
      }
      cy.add({ group:'edges', data: { id, source: from, target: to, rel } });
    }

    function renderList(items) {
      listEl.innerHTML = "";
      if (!items || !items.length) {
        listEl.innerHTML = '<div class="item">Keine Treffer.</div>';
        return;
      }
      const frag = document.createDocumentFragment();
      items.forEach((it) => {
        const p = it.payload || {};
        const id = p.node_id || it.id;
        const name = p.name || id;
        const type = p.type || 'Unknown';
        const score = (typeof it.score === 'number') ? it.score.toFixed(4) : '';
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = '<div style="font-weight:600;">' + name + '</div><div style="color:#9aa5b1;font-size:12px;">' + id + ' · ' + type + ' · score ' + score + '</div>';
        div.addEventListener('click', async () => {
          try {
            upsertNode(p, it.score);
            cy.layout({ name: (typeof window !== 'undefined' && window.fcose) ? 'fcose' : 'cose', quality:'proof', randomize:true, animate:false, fit:true, idealEdgeLength:300, nodeSeparation:360, componentSpacing:480, gravity:0.12, nodeRepulsion:900000, nestingFactor:0.8, packComponents:true, padding:120, nodeDimensionsIncludeLabels:true, tile:true }).run();
            cy.center(cy.getElementById(p.node_id || it.id));
            nodeIdEl.value = p.node_id || it.id;
          } catch (e) {
            console.error(e);
          }
        });
        frag.appendChild(div);
      });
      listEl.appendChild(frag);
    }

    async function doSearch() {
      try {
        const q = (queryEl.value || '').trim();
        const k = parseInt(topKEl.value || '25', 10) || 25;
        if (!q) { setStatus('Bitte Suchtext eingeben.', 'warn'); return; }
        setStatus('Suche läuft…', 'warn');
        const data = await getJSON((window.API_BASE || '') + '/api/kg/search/nodes?query=' + encodeURIComponent(q) + '&top_k=' + encodeURIComponent(k));
        renderList(data.items || []);
        setStatus('Suche OK (' + ((data.items||[]).length) + ')', 'ok');
      } catch (e) {
        console.error(e);
        setStatus('Fehler: ' + e.message, 'err');
      }
    }

    async function doExpand() {
      try {
        const nodeId = (nodeIdEl.value || '').trim();
        if (!nodeId) { setStatus('Bitte Node-ID angeben.', 'warn'); return; }
        const dir = (dirEl.value || 'both');
        const rel = (relEl.value || '').trim();
        const limit = parseInt(limitEl.value || '200', 10) || 200;
        setStatus('Lade Nachbarn…', 'warn');
        const url = new URL('/api/kg/neighbors', window.API_BASE || location.origin);
        url.searchParams.set('node_id', nodeId);
        url.searchParams.set('dir', dir);
        url.searchParams.set('limit', String(limit));
        if (rel) url.searchParams.set('rel', rel);
        const data = await getJSON(url.toString());
        const nodes = data.nodes || [];
        const edges = data.edges || [];
        nodes.forEach((p) => upsertNode(p));
        edges.forEach((p) => upsertEdge(p));
        cy.layout({ name: (typeof window !== 'undefined' && window.fcose) ? 'fcose' : 'cose', quality:'proof', randomize:true, animate:false, fit:true, idealEdgeLength:300, nodeSeparation:360, componentSpacing:480, gravity:0.12, nodeRepulsion:900000, nestingFactor:0.8, packComponents:true, padding:120, nodeDimensionsIncludeLabels:true, tile:true }).run();
        if (cy.getElementById(nodeId).length) {
          cy.center(cy.getElementById(nodeId));
        } else {
          cy.fit();
        }
        setStatus('Nachbarschaft: ' + nodes.length + ' Knoten, ' + edges.length + ' Kanten', 'ok');
      } catch (e) {
        console.error(e);
        setStatus('Fehler: ' + e.message, 'err');
      }
    }

    function doReset() {
      cy.elements().remove();
      listEl.innerHTML = "";
      setStatus('');
    }

    $("#btnKgSearch")?.addEventListener('click', (e) => { e.preventDefault(); doSearch(); });
    $("#btnKgExpand")?.addEventListener('click', (e) => { e.preventDefault(); doExpand(); });
    $("#btnKgReset")?.addEventListener('click', (e) => { e.preventDefault(); doReset(); });

    // Export-Funktionen
    function ts() { return new Date().toISOString().replace(/[:.]/g, "-"); }
    function downloadUrl(url, filename, revoke=false) {
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      if (revoke) setTimeout(() => URL.revokeObjectURL(url), 1000);
    }
    function exportPNG() {
      try {
        const dataUrl = cy.png({ full: true, scale: 2, bg: '#0d1220' });
        downloadUrl(dataUrl, 'kg-' + ts() + '.png');
      } catch (e) { console.error(e); }
    }
    function exportJSON() {
      try {
        const nodes = cy.nodes().map(n => {
          const id = n.id();
          const type = n.data('type') || 'Unknown';
          const name = n.data('name') || id;
          return { id, type, name, payload: { node_id: id, type, name } };
        });
        const edges = cy.edges().map(e => {
          const from = e.source().id();
          const to = e.target().id();
          const rel = e.data('rel') || 'RELATES_TO';
          const id = from + '#' + rel + '#' + to;
          return { id, from, to, rel, payload: { edge_id: id, from_node_id: from, to_node_id: to, rel } };
        });
        const blob = new Blob([JSON.stringify({ nodes, edges }, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        downloadUrl(url, 'kg-' + ts() + '.json', true);
      } catch (e) { console.error(e); }
    }
    $("#btnExportPng")?.addEventListener('click', (e) => { e.preventDefault(); exportPNG(); });
    $("#btnExportJson")?.addEventListener('click', (e) => { e.preventDefault(); exportJSON(); });

    // Optional: initialer Tipp
    setStatus('Tip: Suche z. B. "Benutzer", "Profil", "Passwort" oder eine Req-ID. Knoten anklicken setzt die Node-ID.', '');
  })();
  </script>
</body>
</html>